ext {
    runTestsInFIPSMode = project.hasProperty('runTestsInFIPSMode') ? project.property('runTestsInFIPSMode').toBoolean() : false
}

subprojects {
    ext {
        runTestsInFIPSMode = rootProject.runTestsInFIPSMode
    }
}

allprojects {
    afterEvaluate {
        tasks.withType(Test) {
            if (runTestsInFIPSMode) {
                logger.debug("configuring ${it} to run in FIPSMode ")
                systemProperty "java.security.properties", System.getenv("JAVA_SECURITY_PROPERTIES")
                systemProperty "javax.net.ssl.keyStore", "/etc/java/security/keystore.bcfks"
                systemProperty "javax.net.ssl.keyStoreType", "BCFKS"
                systemProperty "javax.net.ssl.keyStoreProvider", "BCFIPS"
                systemProperty "javax.net.ssl.keyStorePassword", "changeit"
                systemProperty "javax.net.ssl.trustStore", "/etc/java/security/cacerts.bcfks"
                systemProperty "javax.net.ssl.trustStoreType", "BCFKS"
                systemProperty "javax.net.ssl.trustStoreProvider", "BCFIPS"
                systemProperty "javax.net.ssl.trustStorePassword", "changeit"
                systemProperty "ssl.KeyManagerFactory.algorithm", "PKIX"
                systemProperty "ssl.TrustManagerFactory.algorithm", "PKIX"
                systemProperty "org.bouncycastle.fips.approved_only", "true"
            }
        }
    }
}