# Generated by Chef for REDACTED
# Do NOT modify this file by hand.
#
# pfSense
filter {
	if [type] == "syslog" and "pfsense" in [tags] {
		grok {
			match => { "message" => "(?<msg>.*)" }
			id => "filter_grok_pfsense_message"
		}
		mutate {
			gsub => [ "timestamp", "  ", " " ]
			replace => { "message" => "%{msg}" }
			replace => { "host" => "%{logsource}" }
			remove_field => [ "msg" ]			
			id => "filter_mutate_pfsense_tidy_message"
		}
		dns {
			resolve => [ "host" ]
			action => "replace"
			id => "filter_dns_pfsense_host"
		}		
		if [program] == "filterlog" {
			mutate {
				remove_field => [ "msg" ]    
				replace => { "type" => "filterlog" }
				id => "filter_mutate_pfsense_filterlog_remove_fields"
			}
			grok {
				patterns_dir => [ "/etc/logstash/patterns" ]
				patterns_files_glob => "pfsense*"
				match => { "message" => "%{LOG_DATA}%{IP_SPECIFIC_DATA}%{IP_DATA}(%{PROTOCOL_DATA})?" }
				id => "filter_grok_pfsense_filterlog"
			}
			if "_grokparsefailure" not in [tags] {
				geoip {
					add_tag => [ "GeoIP_src" ]
					source => "src_ip"
					target => "geoip_src_ip"
					id => "filter_geoip_pfsense_filterlog_src"
				}
				geoip {
					add_tag => [ "GeoIP_dest" ]
					source => "dest_ip"
					target => "geoip_dest_ip"
					id => "filter_geoip_pfsense_filterlog_dest"
				}		
				mutate {
					add_field => { "src_host" => "%{src_ip}" }
					add_field => { "dest_host" => "%{dest_ip}" }
					lowercase => [ "%{proto}" ]
					id => "filter_mutate_pfsense_filterlog_add_fields"					
				}

				dns {
					action => "replace"
					reverse => [ "src_host" ]
					id => "filter_dns_pfsense_filterlog_src"
				}
				dns {
					action => "replace"
					reverse => [ "dest_host" ]
					id => "filter_dns_pfsense_filterlog_dest"
				}
			}
		}			
		if [program] == "suricata" {
			mutate {
				add_tag => [ "suricata" ]
				id => "filter_mutate_pfsense_suricata_tag"
			}
		}
	}

	# Snort
	if [program] == "snort" {
		mutate {
			add_tag => [ "snort" ]
			add_field => { "src_host" => "%{src_ip}" }
			add_field => { "dest_host" => "%{dest_ip}" }
			id => "filter_mutate_pfsense_snort_tags"
		}
		grok {
			match => { "message" => ["\[%{INT:ids_gid}\:%{INT:ids_sid}\:%{INT:ids_rev}\].%{GREEDYDATA:ids_alert}.\[Classification\: %{DATA:ids_classification}\].*\[Priority\: %{INT:ids_priority}].*{%{WORD:ids_proto}}.*%{IP:src_ip}:%{INT:src_port} \-\>.*%{IP:dest_ip}:%{INT:dest_port}", "\[%{INT:ids_gid}\:%{INT:ids_sid}\:%{INT:ids_rev}\].%{GREEDYDATA:ids_alert}.\[Classification\: %{DATA:ids_classification}\].*\[Priority\: %{INT:ids_priority}].*\{PROTO:%{WORD:ids_proto}.*%{IP:src_ip} \-\>.*%{IP:dest_ip}}" ] }		
			id => "filter_grok_pfsense_snort"
		}
		translate {
			field => "ids_priority"
			destination => "ids_priority_full"
			dictionary => [
			"1", "High",
			"2", "Medium",
			"3", "Low"
			]
			id => "filter_translate_pfsense_snort"
		}
		geoip {
			add_tag => [ "GeoIP_src" ]
			source => "src_ip"
			target => "geoip_src_ip"
			id => "filter_geoip_pfsense_snort_src"
		}
		geoip {
			add_tag => [ "GeoIP_dst" ]
			source => "dest_ip"
			target => "geoip_dest_ip"
			id => "filter_geoip_pfsense_snort_dest"
		}
		dns {
			action => "replace"
			reverse => [ "src_host" ]
			id => "filter_dns_pfsense_snort_src"
		}
		dns {
			action => "replace"
			reverse => [ "dest_host" ]
			id => "filter_dns_pfsense_snort_dest"
		}

		if [ids_signature] {
			if [ids_alert] =~ /^GPL/ {
				mutate {
					add_tag => [ "Snort-ET-sig" ]
					add_field => { "ids_rule_type" => "Emerging Threats" }
					id => "filter_mutate_pfsense_snort_ids_gpl"
				}
			}
			if [ids_alert] =~ /^ET/ {
				mutate {
					add_tag => [ "Snort-ET-sig" ]
					add_field => { "ids_rule_type" => "Emerging Threats" }
					id => "filter_mutate_pfsense_snort_ids_et"
				}
			}
			if "Snort-ET-sig" not in [tags] {
				mutate {
					add_tag => [ "Snort-sig" ]
					add_field => { "ids_rule_type" => "Snort" }
					id => "filter_mutate_pfsense_snort_ids_sig"
				}
			}
		}
		if "Snort-sig" in [tags] {
			if [ids_gid] == "1" {
				mutate {
					add_field => { "Signature_Info" => "http://rootedyour.com/snortsid?sid=%{ids_sid}" }
					id => "filter_mutate_pfsense_snort_ids_gid_1"
				}
			}
			if [ids_gid] != "1" {
				mutate {
					add_field => { "Signature_Info" => "http://rootedyour.com/snortsid?sid=%{ids_gid}-%{ids_sid}" }
					id => "filter_mutate_pfsense_snort_ids_gid_not_1"
				}
			}
			if "Snort-ET-sig" in [tags] {
				mutate {
					add_field => { "Signature_Info" => "http://doc.emergingthreats.net/bin/view/Main/%{ids_sid}" }
					id => "filter_mutate_pfsense_snort_ids_et_sig"
				}
			}
		}
	}
}	
