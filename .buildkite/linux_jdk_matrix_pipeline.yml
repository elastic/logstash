# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json
# Before adding an Operating System to the JDK matrix:
#  - Ensure the image is available in https://github.com/elastic/ci-agent-images/blob/main/vm-images/platform-ingest/logstash-multi-jdk.yml
#  - If image doesn't exist, review https://docs.elastic.dev/ingest-dev-docs/engineer-productivity/custom-ci-images

steps:
  - command: |
      set -euo pipefail

      echo "--- Downloading prerequisites"
      python3 -m pip install ruamel.yaml

      echo "--- Printing generated dynamic steps"
      export MATRIX_OSES="ubuntu-2204"
      export MATRIX_JDKS="adoptiumjdk_17"
      set +eo pipefail
      python3 .buildkite/scripts/jdk-matrix-tests/generate-steps.py >pipeline_steps.yml
      if [[ $$? -ne 0 ]]; then
        echo "^^^ +++"
        echo "There was a problem rendering the pipeline steps."
        cat pipeline_steps.yml
        echo "Exiting now."
        exit 1
      else
        set -eo pipefail
        cat pipeline_steps.yml
      fi

      echo "--- Uploading steps to buildkite"
      cat pipeline_steps.yml | buildkite-agent pipeline upload
