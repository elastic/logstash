require "rspec"
require "rspec/core/runner"
require "rspec/core/rake_task"
require_relative "vagrant-helpers"
require_relative "platform_config"

platforms = PlatformConfig.new

task :spec    => 'spec:all'
task :default => :spec

namespace :test do
  desc "Generate a valid ssh-config"
  task :ssh_config do
    require "json"
    cd "acceptance" do
      raw_ssh_config    = LogStash::VagrantHelpers.fetch_config[:stdout].split("\n");
      parsed_ssh_config = LogStash::VagrantHelpers.parse(raw_ssh_config)
      File.write("../.vm_ssh_config", parsed_ssh_config.to_json)
    end
  end

  desc "Bootstrap all the VM's used for this tests"
  task "setup" do
    puts "bootstraping all VM's defined in acceptance/Vagrantfile"
    LogStash::VagrantHelpers.bootstrap
  end

  namespace :acceptance do

    desc "Run all acceptance"
    task :all do
      exit(RSpec::Core::Runner.run([Rake::FileList["acceptance/spec/**/*_spec.rb"]]))
    end

    platforms.types.each do |type|
      desc "Run acceptance test in #{type} machines"
      task type do
        exit(RSpec::Core::Runner.run([Rake::FileList["acceptance/spec/#{type}/**/*_spec.rb"]]))
      end
    end

    desc "Run one single machine acceptance test"
    task :single, :machine do  |t, args|
      ENV['LS_VAGRANT_HOST'] = args[:machine]
      platform = LogStash::VagrantHelpers.translate(args[:machine])
      exit(RSpec::Core::Runner.run([Rake::FileList["acceptance/spec/**/*_spec.rb"]]))
    end
  end
end
