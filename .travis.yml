sudo: required
services:
  - docker
cache:
  directories:
    - vendor/bundle
    - ~/.gradle/
jdk:
  - oraclejdk8
env:
  - INTEGRATION=false SPEC_OPTS="--order rand --format documentation" JRUBY_OPTS='-Xcompile.invokedynamic=false'
  - INTEGRATION=true SPEC_OPTS="--order rand --format documentation" JRUBY_OPTS='-Xcompile.invokedynamic=false'
  - INTEGRATION=false FEATURE_FLAG=persistent_queues SPEC_OPTS="--order rand --format documentation" JRUBY_OPTS='-Xcompile.invokedynamic=false'
  - INTEGRATION=true FEATURE_FLAG=persistent_queues SPEC_OPTS="--order rand --format documentation" JRUBY_OPTS='-Xcompile.invokedynamic=false'
before_install:
  - sudo apt-get update && sudo apt-get install -y docker-ce
  - sudo service docker stop
  - sudo dockerd --disable-legacy-registry &>/dev/null &
  - export JRUBY_OPTS=""
  - wget http://central.maven.org/maven2/org/jruby/jruby-dist/9.1.13.0/jruby-dist-9.1.13.0-bin.tar.gz
  - tar xvf jruby-dist-9.1.13.0-bin.tar.gz --strip 1 -C ~/jruby
  - export PATH=~/jruby/bin:$PATH 
install:
  - export PATH=~/jruby/bin:$PATH
  - gem install rake
  - gem install bundler
  - rake test:install-core
script:
  - export PATH=~/jruby/bin:$PATH
  - |+
      if [ "$INTEGRATION" == "true" ]; then
        ci/travis_integration_install.sh
        ci/travis_integration_run.sh;
      else
        rake test:core
      fi
