---
name: Update logstash lockfile
pipelineid: "logstash/version-updates"

scms:
  default:
    kind: github
    spec:
      user: '{{ requiredEnv "GITHUB_ACTOR" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      owner: '{{ .scm.owner }}'
      repository: '{{ .scm.repository }}'
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      branch: '{{ requiredEnv "LOGSTASH_BRANCH" }}'
      commitusingapi: true
      force: false

conditions:
  lockfile_exists:
    name: Check if lockfile exists
    kind: file
    disablesourceinput: true
    spec:
      file: Gemfile.jruby-3.1.lock.release

targets:
  update_gemfile_lock_dependency:
    name: Update logstash-core dependency in lockfile
    kind: file
    disablesourceinput: true
    conditionsids:
      - lockfile_exists
    spec:
      file: Gemfile.jruby-3.1.lock.release
      matchpattern: 'logstash-core \(= [0-9]+\.[0-9]+\.[0-9]+'
      replacepattern: 'logstash-core (= {{ requiredEnv "LOGSTASH_VERSION" }}'
  
  update_gemfile_lock_spec:
    name: Update logstash-core spec in lockfile
    kind: file
    disablesourceinput: true
    conditionsids:
      - lockfile_exists
    spec:
      file: Gemfile.jruby-3.1.lock.release
      matchpattern: 'logstash-core \([0-9]+\.[0-9]+\.[0-9]+-java\)'
      replacepattern: 'logstash-core ({{ requiredEnv "LOGSTASH_VERSION" }}-java)'